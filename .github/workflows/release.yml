name: Release to PyPI

on:
  release:
    types: [published]

jobs:
  # =========================
  # PRE-RELEASE VALIDATION
  # =========================
  validate-release:
    name: Validate Release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Verify version matches tag
        run: |
          TAG_VERSION="${{ github.event.release.tag_name }}"
          TAG_VERSION="${TAG_VERSION#v}"  # Remove 'v' prefix if present
          
          # Extract version from pyproject.toml
          PKG_VERSION=$(python -c "
          import tomllib
          with open('pyproject.toml', 'rb') as f:
              data = tomllib.load(f)
          print(data['project']['version'])
          ")
          
          if [ "$TAG_VERSION" != "$PKG_VERSION" ]; then
            echo "‚ùå Version mismatch!"
            echo "   Git tag: v$TAG_VERSION"
            echo "   pyproject.toml: $PKG_VERSION"
            exit 1
          fi
          
          echo "‚úÖ Version matches: $TAG_VERSION"

  # =========================
  # FINAL UNIT TESTS
  # =========================
  final-tests:
    name: Final Unit Tests
    runs-on: ubuntu-latest
    needs: validate-release
    environment: cleancloud-test

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,aws,azure]"

      - name: Run tests
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        run: pytest tests/ -v

  # =========================
  # FINAL INTEGRATION TESTS (REQUIRED)
  # =========================
  final-integration-aws:
    name: Final AWS Integration Test
    runs-on: ubuntu-latest
    needs: validate-release
    environment: cleancloud-test

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install CleanCloud
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,aws,azure]"

      - name: Test AWS (strict)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1
        run: |
          set -e
          cleancloud doctor --provider aws --region us-east-1
          cleancloud scan --provider aws --region us-east-1

  final-integration-azure:
    name: Final Azure Integration Test
    runs-on: ubuntu-latest
    needs: validate-release
    environment: cleancloud-test

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install CleanCloud
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,aws,azure]"

      - name: Test Azure (strict, with retry)
        uses: nick-fields/retry-action@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            set -e
            cleancloud doctor --provider azure
            cleancloud scan --provider azure
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  # =========================
  # BUILD & PUBLISH
  # =========================
  build-and-publish:
    name: Build and Publish to PyPI
    runs-on: ubuntu-latest
    needs: [final-tests, final-integration-aws, final-integration-azure]
    environment: pypi
    permissions:
      id-token: write  # Required for trusted publishing

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: python -m build

      - name: Check package
        run: twine check dist/*

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          skip-existing: true

      - name: Comment on release
        uses: actions/github-script@v7
        with:
          script: |
            const tag = context.payload.release.tag_name;
            const releaseUrl = context.payload.release.html_url;
            const pypiUrl = `https://pypi.org/project/cleancloud/${tag.replace('v', '')}/`;
            
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `‚úÖ Successfully published **${tag}** to PyPI!\n\nüì¶ Install: \`pip install cleancloud==${tag.replace('v', '')}\`\nüîó PyPI: ${pypiUrl}\nüéâ Release: ${releaseUrl}`
            });